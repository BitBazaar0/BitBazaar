// Prisma Schema for BitBazaar Marketplace
// This schema matches your current data models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique // e.g., "GPU", "CPU", "RAM"
  slug        String    @unique // URL-friendly version
  displayName String    // e.g., "GPUS", "CPUS"
  icon        String?   // Optional icon identifier
  color       String?   // Optional hex color for UI
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  listings Listing[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  username          String   @unique
  password          String
  firstName         String?
  lastName          String?
  location          String?
  phone             String?
  avatar            String?
  emailVerified     Boolean  @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  listingsAsSeller Listing[] @relation("SellerListings")
  favorites Favorite[]
  reviewsGiven Review[] @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")
  chatsAsBuyer Chat[] @relation("BuyerChats")
  chatsAsSeller Chat[] @relation("SellerChats")
  messagesSent Message[]

  @@map("users")
}

model Listing {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  categoryId  String   // Required: all listings must have a category
  brand       String?
  model       String?
  condition   String
  price       Int
  location    String
  images      String[] // Array of image URLs
  sellerId    String
  views       Int      @default(0)
  isActive    Boolean  @default(true)
  isBoosted   Boolean  @default(false)
  isSold      Boolean  @default(false)
  expiresAt   DateTime? // 3 weeks from creation
  deletedAt   DateTime? // 5 weeks from creation (permanent deletion date)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller User      @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  favorites Favorite[]
  reviews Review[]
  chats Chat[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([isActive])
  @@index([isBoosted])
  @@index([isSold])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("listings")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())

  // Relations
  user User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@map("favorites")
}

model Review {
  id         String   @id @default(cuid())
  listingId  String?
  reviewerId String
  revieweeId String
  rating     Int      // 1-5 stars
  comment    String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  listing Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)
  reviewer User    @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewee User    @relation("Reviewee", fields: [revieweeId], references: [id], onDelete: Cascade)

  @@index([reviewerId])
  @@index([revieweeId])
  @@index([listingId])
  @@map("reviews")
}

model Chat {
  id        String   @id @default(cuid())
  listingId String
  buyerId   String
  sellerId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer User    @relation("BuyerChats", fields: [buyerId], references: [id], onDelete: Cascade)
  seller User   @relation("SellerChats", fields: [sellerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([listingId, buyerId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@map("chats")
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  senderId  String
  content   String   @db.Text
  imageUrl  String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// Future model for Phase 2 (Orders/Transactions)
// Uncomment when ready to implement

// model Order {
//   id          String   @id @default(cuid())
//   listingId   String
//   buyerId     String
//   sellerId    String
//   amount      Int
//   status      String   @default("pending")
//   paymentId   String?
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt

//   listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
//   buyer User @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
//   seller User @relation("SellerOrders", fields: [sellerId], references: [id], onDelete: Cascade)

//   @@index([buyerId])
//   @@index([sellerId])
//   @@index([status])
//   @@map("orders")
// }
